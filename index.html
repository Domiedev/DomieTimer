<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Setup</title>
    <style>
        body {
            background-color: #000000;
            color: white;
            font-family: Arial, sans-serif;
        }
        #timerDisplay {
            font-size: 2em;
            margin: 20px;
        }
        .hidden {
            display: none;
        }
        #passwordField {
            margin: 20px;
            padding: 10px;
            background-color: #444;
            border: 1px solid #888;
            color: white;
            font-size: 1.2em;
        }
        button {
            padding: 10px;
            background-color: #444;
            color: white;
            border: 1px solid #888;
            cursor: pointer;
        }
        button:hover {
            background-color: #555;
        }
        .button-container {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>

<h1>How Long Does Domie Need?</h1>

<!-- Display the timer for everyone -->
<div id="publicTimerDisplay">
    <div id="timerDisplay">Loading Timer...</div>
</div>

<div id="passwordSection">
    <input type="password" id="passwordField" placeholder="Enter password">
    <button id="submitPasswordBtn">Submit</button>
</div>

<div id="timerSection" class="hidden">
    <label for="timerInput">Enter timer (Minutes only):</label>
    <input type="number" id="timerInput" placeholder="Minutes" min="1">
    <button id="setTimerBtn">Set Timer</button>
    <div class="button-container">
        <button onclick="addFiveMinutes()">Add 5 Minutes</button>
        <button onclick="resetTimer()">Reset Timer</button>
    </div>
</div>

<script>
    const timerRef = "https://api.jsonbin.io/v3/b/680411228561e97a50033b62"; // your jsonbin URL
    const X_MASTER_KEY = "$2a$10$eO4Awo0t5OAD8xVHkj31Ou2cuntC2OeoFX7vIPL6APc9lUZKAgeBW";
    let countdownInterval;

    // Show the current timer from JSON bin
    function showTimer() {
        fetch(timerRef, {
            headers: {
                "X-Master-Key": X_MASTER_KEY
            }
        })
        .then(response => response.json())
        .then(data => {
            const timer = data.record.timer || 0;
            document.getElementById("timerDisplay").innerText = formatTime(timer);
            if (timer > 0) {
                startCountdown(timer); // Start countdown if timer > 0
            }
        })
        .catch(error => {
            console.log("Error fetching timer data:", error);
        });
    }

    // Format the time (minutes and seconds)
    function formatTime(timeInMinutes) {
        const minutes = Math.floor(timeInMinutes);
        const seconds = Math.floor((timeInMinutes - minutes) * 60);
        return `${minutes}m ${seconds}s`;
    }

    // Start countdown
    function startCountdown(timeInMinutes) {
        if (countdownInterval) {
            clearInterval(countdownInterval); // Clear existing interval if any
        }

        countdownInterval = setInterval(() => {
            fetch(timerRef, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": X_MASTER_KEY
                },
                body: JSON.stringify({ record: { timer: timeInMinutes - 0.0167 } }) // Decrease by ~1 second
            })
            .then(response => response.json())
            .then(data => {
                const updatedTime = data.record.timer;
                document.getElementById("timerDisplay").innerText = formatTime(updatedTime);
                if (updatedTime <= 0) {
                    clearInterval(countdownInterval);
                    alert("Timer Finished!");
                    resetTimer(); // Reset the timer when it finishes
                }
            })
            .catch(error => {
                console.log("Error updating timer:", error);
            });

            timeInMinutes -= 0.0167; // Decrease time by ~1 second (1/60)
        }, 1000); // Update every second
    }

    // Set timer
    function setTimer() {
        const timerInput = document.getElementById("timerInput").value;
        if (timerInput && timerInput > 0) {
            const timerInMinutes = parseFloat(timerInput);
            fetch(timerRef, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": X_MASTER_KEY
                },
                body: JSON.stringify({ record: { timer: timerInMinutes } })
            })
            .then(() => {
                showTimer(); // Update display after setting the timer
            })
            .catch(error => {
                console.log("Error setting timer:", error);
            });
        }
    }

    // Add 5 minutes
    function addFiveMinutes() {
        fetch(timerRef, {
            headers: {
                "X-Master-Key": X_MASTER_KEY
            }
        })
        .then(response => response.json())
        .then(data => {
            const currentTimer = data.record.timer || 0;
            const updatedTimer = currentTimer + 5;
            fetch(timerRef, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": X_MASTER_KEY
                },
                body: JSON.stringify({ record: { timer: updatedTimer } })
            })
            .then(() => showTimer()) // Show updated timer
            .catch(error => console.log("Error updating timer:", error));
        })
        .catch(error => console.log("Error fetching timer data:", error));
    }

    // Reset timer
    function resetTimer() {
        fetch(timerRef, {
            method: 'PUT',
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": X_MASTER_KEY
            },
            body: JSON.stringify({ record: { timer: 0 } })
        })
        .then(() => {
            document.getElementById("timerDisplay").innerText = formatTime(0);
        })
        .catch(error => console.log("Error resetting timer:", error));
    }

    // Password check
    document.getElementById("submitPasswordBtn").addEventListener("click", () => {
        const password = document.getElementById("passwordField").value;
        if (password === "1234") {
            document.getElementById("passwordSection").classList.add("hidden");
            document.getElementById("timerSection").classList.remove("hidden");
        } else {
            alert("Incorrect password!");
        }
    });

    // Show timer initially
    showTimer();

    // Set timer event listener
    document.getElementById("setTimerBtn").addEventListener("click", setTimer);
</script>

</body>
</html>
